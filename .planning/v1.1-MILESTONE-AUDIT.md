---
milestone: v1.1
audited: 2026-01-17
status: gaps_found
scores:
  requirements: 9/11
  phases: 5/5
  integration: 1/3
  flows: 2/3
gaps:
  requirements:
    - SEC-02 (Partial - Backend ready, frontend missing)
    - AUTH-06 (Verified, but flow is redundant)
  integration:
    - "App Check: Backend expects header, Frontend never sends it"
    - "Auth Routes: Legacy endpoints (/request-otp) still active alongside Firebase"
  flows:
    - "Buyer Login: Redundant 'double-entry' flow (Legacy OTP -> Firebase OTP)"
tech_debt:
  - phase: 18-backend-auth
    items:
      - "Dead code: /auth/request-otp and /auth/verify-otp endpoints unused by new flow"
  - phase: 19-client-auth
    items:
      - "Confusing UX: User enters phone twice (BuyerLoginPage -> PhoneLoginForm)"
---

# Milestone v1.1 Audit Report

**Status:** ⚠ Gaps Found
**Definition of Done:** Production deployment with robust, secure SMS authentication.

## Requirements Coverage

| ID | Requirement | Status | Issue |
|---|---|---|---|
| AUTH-01 | Request OTP (Firebase) | ✓ Satisfied | |
| AUTH-02 | Verify OTP (Firebase) | ✓ Satisfied | |
| AUTH-03 | Invisible reCAPTCHA | ✓ Satisfied | |
| AUTH-04 | Token Exchange | ✓ Satisfied | |
| AUTH-05 | User Sync | ✓ Satisfied | |
| AUTH-06 | Resend Cooldown | ✓ Satisfied | |
| SEC-01 | Whitelist Test Numbers | ✓ Satisfied | |
| SEC-02 | App Check Enabled | ⚠️ Partial | Backend validates, Frontend **does not send token** |
| SEC-03 | Rate Limiting | ✓ Satisfied | |
| SEC-04 | Custom Auth Domain | ✓ Satisfied | Verified DNS |
| CMP-01 | DLT Registration | ✓ Satisfied | Infrastructure ready |

## Cross-Phase Integration

### ❌ Critical: App Check Token Flow
- **Backend (Phase 20):** Middleware `verifyAppCheck` is active and monitoring.
- **Frontend (Phase 19):** `web/src/lib/api.ts` does **not** fetch or attach the App Check token.
- **Impact:** If `APP_CHECK_ENFORCED=true` is set, all legitimate web clients will be blocked (401 Unauthorized).

### ⚠️ Warning: "Split-Brain" Authentication
- **Phase 18 (Backend):** Implemented new `/auth/firebase-verify` but kept legacy `/auth/request-otp`.
- **Phase 19 (Frontend):** `BuyerLoginPage` still calls legacy `/auth/request-otp` before redirecting to the new Firebase page.
- **Result:** Every login attempt generates a useless mock OTP in the database before the real Firebase flow starts.

## End-to-End User Flows

### ❌ Buyer Login Flow
1. User enters phone on Login Page.
2. **Legacy Call:** App requests mock OTP (useless).
3. App navigates to Verification Page.
4. **Redundant UI:** User sees "Send OTP" button *again* (Firebase flow).
5. User must click again to get real SMS.
6. **Verdict:** Functional but broken UX.

### ✓ Admin Login Flow
- Email/Password flow remains solid and unaffected by changes.

## Recommendations

1. **Wire App Check:** Update frontend `api.ts` to include `X-Firebase-AppCheck` header.
2. **Fix Login UX:** Refactor `BuyerLoginPage` to use `usePhoneAuth` directly (or redirect immediately), removing the legacy API call.
3. **Cleanup:** Deprecate legacy auth endpoints.

---
phase: 05-batch-management
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - web/src/pages/admin/BatchDetailPage.tsx
  - web/src/App.tsx
autonomous: false
---

<objective>
Build the Batch detail page with state transition controls.

Purpose: Enable admins to view batch details and advance batches through their lifecycle with clear confirmation flows.

Output: BatchDetailPage with batch info, timeline visualization, and state transition controls.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-batch-management/05-CONTEXT.md

# Existing UI patterns:
@web/src/pages/admin/FarmerDetailPage.tsx
@web/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: BatchDetailPage with batch information</name>
  <files>web/src/pages/admin/BatchDetailPage.tsx, web/src/App.tsx</files>
  <action>
Create BatchDetailPage following FarmerDetailPage pattern:

**Layout:**
- Header: Batch name with status badge
- Info card:
  - Hub name and address
  - Cutoff date/time (with "Passed" indicator if in past)
  - Delivery date
  - Created date
  - Current status with timeline visualization

**Timeline visualization:**
```
DRAFT → OPEN → CLOSED → COLLECTED → DELIVERED → SETTLED
  ●       ○       ○         ○           ○          ○
(completed states filled, current state highlighted, future states empty)
```

Use flexbox with circles/lines. Completed states: filled green. Current: highlighted with ring. Future: empty gray.

**API:** GET /batches/:id

**Register route in App.tsx:** /admin/batches/:id → BatchDetailPage

**Navigation:**
- Back link to /admin/batches
- Edit link (only show for DRAFT batches)
  </action>
  <verify>npm run build succeeds, page renders at /admin/batches/:id</verify>
  <done>BatchDetailPage shows batch info with timeline visualization</done>
</task>

<task type="auto">
  <name>Task 2: State transition controls with confirmation</name>
  <files>web/src/pages/admin/BatchDetailPage.tsx</files>
  <action>
Add state transition controls to BatchDetailPage:

**Transition button:**
- Show single prominent button for the next valid state
- Button text varies by transition:
  - DRAFT → OPEN: "Open Batch for Orders"
  - OPEN → CLOSED: "Close Batch (Lock Orders)"
  - CLOSED → COLLECTED: "Mark as Collected"
  - COLLECTED → DELIVERED: "Mark as Delivered"
  - DELIVERED → SETTLED: "Mark as Settled"
- SETTLED: No button (terminal state, show "Batch Complete" message)

**Confirmation modal:**
- On button click, show modal with:
  - Title: "Confirm Status Change"
  - Message explaining the action and that it's irreversible
  - Current status → New status
  - Cancel and Confirm buttons
- For DRAFT → OPEN: Additional warning if cutoff is less than 1 hour away

**On confirm:**
- POST /batches/:id/transition with { targetStatus: 'NEXT_STATE' }
- Show loading state
- On success: refresh page data, show success toast
- On error: show error message (e.g., "Invalid transition" from API)

**Visual feedback:**
- Button disabled during loading
- Success: green toast notification
- Error: red toast notification with API error message

**Important:** No going backwards. Each transition is permanent. Make this clear in the confirmation modal.
  </action>
  <verify>npm run build succeeds, clicking transition shows confirmation modal</verify>
  <done>State transitions work with confirmation, API calls succeed, errors handled gracefully</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Batch detail page with timeline and state transition controls</what-built>
  <how-to-verify>
    1. Run: cd server && npm run dev (in one terminal)
    2. Run: cd web && npm run dev (in another terminal)
    3. Visit: http://localhost:5173/admin/batches (login as admin)
    4. Create a new DRAFT batch if none exists
    5. Click on the batch to go to detail page
    6. Verify:
       - Batch info displays correctly (hub, cutoff, delivery)
       - Timeline shows DRAFT as current (highlighted)
       - "Open Batch for Orders" button is visible
    7. Click "Open Batch for Orders"
    8. Verify confirmation modal appears with warning about irreversibility
    9. Click "Confirm"
    10. Verify:
        - Status changes to OPEN
        - Timeline updates (DRAFT filled, OPEN highlighted)
        - Button changes to "Close Batch (Lock Orders)"
    11. Repeat for OPEN → CLOSED transition
    12. Verify SETTLED shows "Batch Complete" with no button
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds
- [ ] BatchDetailPage shows batch info correctly
- [ ] Timeline visualization works
- [ ] State transition button appears with correct label
- [ ] Confirmation modal shows before transition
- [ ] Transitions work correctly (API called, UI updates)
- [ ] Human verification approved
</verification>

<success_criteria>
- All tasks completed
- Human verified state transitions work correctly
- No TypeScript/build errors
- Timeline visualization is clear
- Confirmation prevents accidental transitions
</success_criteria>

<output>
After completion, create `.planning/phases/05-batch-management/05-03-SUMMARY.md`
</output>

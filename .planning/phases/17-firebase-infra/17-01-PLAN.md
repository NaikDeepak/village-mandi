---
phase: 17-firebase-infra
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [.env]
autonomous: false
user_setup:
  - service: firebase
    why: "Phone authentication infrastructure"
    env_vars:
      - name: VITE_FIREBASE_API_KEY
        source: "Firebase Console → Project Settings → General → Web App"
      - name: VITE_FIREBASE_AUTH_DOMAIN
        source: "Firebase Console → Project Settings → General → Web App"
      - name: VITE_FIREBASE_PROJECT_ID
        source: "Firebase Console → Project Settings → General → Web App"
      - name: VITE_FIREBASE_APP_ID
        source: "Firebase Console → Project Settings → General → Web App"
      - name: FIREBASE_SERVICE_ACCOUNT_JSON
        source: "Firebase Console → Project Settings → Service Accounts → Generate new private key"
    dashboard_config:
      - task: "Create Firebase Project"
        location: "https://console.firebase.google.com/"
        details: "Name: Village Mandi (or apnakhet)"
      - task: "Add Web App"
        location: "Project Settings → General"
        details: "Register app to get config object"
      - task: "Enable Phone Auth"
        location: "Authentication → Sign-in method → Phone"
        details: "Enable Phone"
      - task: "Add Test Phone Numbers"
        location: "Authentication → Sign-in method → Phone → Phone numbers for testing"
        details: "Add at least one test number (e.g., +91 9999999999 / 123456)"
      - task: "Configure Custom Domain"
        location: "Hosting (or Authentication → Settings → Authorized domains)"
        details: "Add auth.apnakhet.app and verify DNS records"

must_haves:
  truths:
    - "Custom domain auth.apnakhet.app resolves to Firebase"
    - "Test phone number login works"
    - "Real phone number receives SMS (manual verification)"
  artifacts:
    - path: ".env"
      provides: "Firebase credentials"
      contains: "VITE_FIREBASE_API_KEY"
  key_links: []
---

<objective>
Configure Firebase infrastructure for Phone Authentication.

Purpose: Establish the identity provider foundation before integrating into the app.
Output: Firebase project configured, custom domain active, API keys in .env.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-firebase-infra/17-CONTEXT.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Create and configure Firebase Project</action>
  <instructions>
    1. Go to https://console.firebase.google.com/
    2. Create project "Village Mandi" (or "apnakhet")
    3. Enable Authentication -> Sign-in method -> Phone
    4. Add a test phone number (e.g., +91 9999999999 / 123456)
    5. Register a Web App in Project Settings -> General
    6. Configure Custom Domain:
       - Go to Authentication -> Settings -> Authorized domains (or Hosting)
       - Add `auth.apnakhet.app`
       - Update DNS records at name.com as instructed by Firebase
  </instructions>
  <verification>Firebase Console shows "Connected" for custom domain (may take time)</verification>
  <resume-signal>Type "done" when project is created and DNS records are added</resume-signal>
</task>

<task type="auto">
  <name>Capture Firebase Configuration</name>
  <files>.env</files>
  <action>
    Ask user for the Firebase configuration values (API Key, Auth Domain, Project ID, App ID) and the Service Account JSON content.
    Write these to `.env` file (append if exists).

    Format:
    VITE_FIREBASE_API_KEY=...
    VITE_FIREBASE_AUTH_DOMAIN=auth.apnakhet.app
    VITE_FIREBASE_PROJECT_ID=...
    VITE_FIREBASE_APP_ID=...
    FIREBASE_SERVICE_ACCOUNT_JSON=...
  </action>
  <verify>cat .env shows new variables</verify>
  <done>.env updated with Firebase credentials</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Firebase Infrastructure Configuration</what-built>
  <how-to-verify>
    1. Verify Custom Domain:
       - Visit https://auth.apnakhet.app/__/auth/handler
       - Should show a blank page or Firebase 404 (not a DNS error)
    2. Verify SMS Delivery (Manual Test):
       - This requires a quick client-side test or using the "Send test SMS" feature in Firebase if available (often not exposed directly).
       - Alternatively, we will verify this in Phase 19 (Client Auth).
       - For now, confirm the domain resolution.
  </how-to-verify>
  <resume-signal>Type "approved" if domain resolves, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] .env contains VITE_FIREBASE_* variables
- [ ] Custom domain resolves
</verification>

<success_criteria>
- Firebase Project created and configured
- Custom domain `auth.apnakhet.app` linked
- Credentials saved to environment file
</success_criteria>

<output>
After completion, create `.planning/phases/17-firebase-infra/17-01-SUMMARY.md`
</output>

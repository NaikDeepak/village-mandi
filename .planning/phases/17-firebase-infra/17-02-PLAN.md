---
phase: 17-firebase-infra
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [.env]
autonomous: false
gap_closure: true
must_haves:
  truths:
    - "Custom domain auth.apnakhet.app resolves to Firebase"
    - ".env VITE_FIREBASE_AUTH_DOMAIN is correctly set to auth.apnakhet.app"
  artifacts:
    - path: ".env"
      provides: "Correct Firebase Auth Domain"
      contains: "VITE_FIREBASE_AUTH_DOMAIN=auth.apnakhet.app"
  key_links: []
---

<objective>
Fix configuration gaps identified in Phase 17 verification.

Purpose: Ensure environment variables match the intended custom domain configuration for Safari/iOS compatibility.
Output: Corrected .env file and verified DNS resolution.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-firebase-infra/17-01-SUMMARY.md
@.planning/phases/17-firebase-infra/17-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Correct VITE_FIREBASE_AUTH_DOMAIN in .env</name>
  <files>.env</files>
  <action>
    Update VITE_FIREBASE_AUTH_DOMAIN from `apnakhet-app.firebaseapp.com` to `auth.apnakhet.app`.
    This ensures the client SDK uses the custom domain, which is critical for bypassing Safari ITP restrictions.
  </action>
  <verify>grep "VITE_FIREBASE_AUTH_DOMAIN=auth.apnakhet.app" .env</verify>
  <done>.env updated with correct custom domain</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>DNS Configuration for auth.apnakhet.app</what-built>
  <how-to-verify>
    1. Verify DNS Propagation:
       - Run `nslookup auth.apnakhet.app` (or use an online tool like mxtoolbox.com)
       - It should return CNAME records pointing to Firebase Hosting
    2. Verify Browser Resolution:
       - Visit https://auth.apnakhet.app/__/auth/handler
       - Should verify secure connection and show Firebase handler page (not DNS error)
    3. Verify SMS (Optional but recommended):
       - If possible, verify an SMS can be triggered (requires client code or Firebase console)
  </how-to-verify>
  <resume-signal>Type "approved" if DNS resolves, or "issue" to report DNS problems</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] .env contains VITE_FIREBASE_AUTH_DOMAIN=auth.apnakhet.app
- [ ] DNS resolution confirmed by user
</verification>

<success_criteria>
- Configuration gap closed
- Environment matches infrastructure reality
</success_criteria>

<output>
After completion, create `.planning/phases/17-firebase-infra/17-02-SUMMARY.md`
</output>

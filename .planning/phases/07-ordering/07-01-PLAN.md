---
phase: 07-ordering
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified: [server/src/routes/orders.ts, server/src/routes/orders.test.ts, server/src/routes/batches.ts, server/src/routes/batch-products.ts, server/src/schemas/orders.ts]
autonomous: true
---

<objective>
Implement secure Order Placement API and update access controls for Buyer visibility.

Purpose: Allow buyers to view open batches/products and place valid orders with MOQ enforcement.
Output: Validated `POST /orders` endpoint and buyer-accessible GET endpoints.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/prisma/schema.prisma
@server/src/routes/batches.ts
@server/src/routes/batch-products.ts
</context>

<feature>
  <name>Order Placement & Access</name>
  <files>server/src/routes/orders.ts, server/src/routes/orders.test.ts</files>
  <behavior>
    1. GET /batches/current: Allow BUYER role to view (currently ADMIN only).
    2. GET /batches/:id/products: Allow BUYER role to view (currently ADMIN only).
    3. POST /orders:
       - Reject if Batch is not OPEN.
       - Reject if Batch cutoff has passed.
       - Reject if Item Qty < MinOrderQty.
       - Reject if Item Qty > MaxOrderQty.
       - Calculate total and commitment fee (10%).
       - Create Order + OrderItems transactionally.
       - Log EventLog for ORDER_CREATED.
  </behavior>
  <implementation>
    - Update `requireAdmin` to `requireAuth` for specific GET routes in batches.ts/batch-products.ts.
    - Create `createOrderSchema` in `schemas/orders.ts`.
    - Implement `orders.ts` routes.
  </implementation>
</feature>

<verification>
npm test server/src/routes/orders.test.ts
</verification>

<success_criteria>
- Failing test written for Order constraints
- Access control updated for Buyer visibility
- Implementation passes all tests
- API rejects invalid orders (closed batch, past cutoff, invalid qty)
</success_criteria>

<output>
After completion, create `.planning/phases/07-ordering/07-01-SUMMARY.md`
</output>

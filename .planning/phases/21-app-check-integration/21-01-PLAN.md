---
phase: 21-app-check-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [web/src/lib/firebase.ts, web/src/lib/api.ts, web/.env.example]
autonomous: true
status: COMPLETED
completed_at: 2026-01-17
must_haves:
  truths:
    - "Frontend requests include App Check token header"
    - "App Check initialized with ReCAPTCHA V3"
  artifacts:
    - path: "web/src/lib/firebase.ts"
      provides: "App Check initialization with ReCaptchaV3Provider"
    - path: "web/src/lib/api.ts"
      provides: "X-Firebase-AppCheck header injection"
  key_links:
    - from: "web/src/lib/api.ts"
      to: "X-Firebase-AppCheck header"
      via: "getToken(appCheck)"
---

<objective>
Implement Firebase App Check on the frontend.

Purpose: Close the security gap where backend expects App Check tokens but frontend never sends them.
Output: Wired frontend that authenticates its legitimacy to the backend.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.1-MILESTONE-AUDIT.md
@web/package.json
</context>

<tasks>

<task type="auto" status="DONE">
  <name>Install App Check Dependency</name>
  <files>web/package.json</files>
  <action>
    Since we are using the modular `firebase` SDK (v12+), App Check is included.
    Verified `firebase: ^12.8.0` in package.json.
  </action>
  <verify>grep "firebase" web/package.json → "firebase": "^12.8.0"</verify>
  <done>✅ Dependency ready</done>
</task>

<task type="auto" status="DONE">
  <name>Initialize App Check</name>
  <files>web/src/lib/firebase.ts, web/.env.example</files>
  <action>
    Imported `initializeAppCheck`, `ReCaptchaV3Provider` from `firebase/app-check`.
    Initialized with:
    ```typescript
    export const appCheck = initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider(
        import.meta.env.VITE_RECAPTCHA_SITE_KEY || '6Lc_placeholder_key_for_dev'
      ),
      isTokenAutoRefreshEnabled: true,
    });
    ```
    Uses ReCaptchaV3Provider (not Enterprise) as standard for web apps.
    Placeholder key for dev, real key via VITE_RECAPTCHA_SITE_KEY in production.
  </action>
  <verify>App Check initialized in web/src/lib/firebase.ts lines 19-24</verify>
  <done>✅ App Check active</done>
</task>

<task type="auto" status="DONE">
  <name>Attach Token to API Requests</name>
  <files>web/src/lib/api.ts</files>
  <action>
    Modified the base `request()` fetch wrapper to:
    1. Import `getToken` from `firebase/app-check`
    2. Import `appCheck` from `./firebase`
    3. Get App Check token: `await getToken(appCheck)`
    4. Add header `X-Firebase-AppCheck: token.token` to all requests
    5. Gracefully handle failures (log warning, continue without blocking)
  </action>
  <verify>API client lines 20-29 include header injection logic</verify>
  <done>✅ Tokens sent to backend</done>
</task>

</tasks>

<verification>
All verified 2026-01-17:
- [x] `npm run build` in web succeeds
- [x] App Check initialized with ReCaptchaV3Provider
- [x] X-Firebase-AppCheck header injected in all API requests
- [x] Graceful error handling when token retrieval fails
</verification>

<success_criteria status="ACHIEVED">
- ✅ Frontend wired to send App Check tokens
- ✅ Code compiles (build passes)
</success_criteria>

<output>
Summary created: `.planning/phases/21-app-check-integration/21-01-SUMMARY.md`
Verification report: `.planning/phases/21-app-check-integration/21-VERIFICATION.md` (5/5 truths verified)
</output>

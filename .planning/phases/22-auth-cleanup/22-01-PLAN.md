---
phase: 22-auth-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [server/src/routes/auth.ts, web/src/lib/api.ts, web/src/pages/BuyerLoginPage.tsx, web/src/components/auth/PhoneLoginForm.tsx, web/src/hooks/usePhoneAuth.ts]
autonomous: true
must_haves:
  truths:
    - "Legacy auth routes removed"
    - "Buyer login uses Firebase flow exclusively"
    - "VerifyOtpPage deleted"
  artifacts:
    - path: "server/src/routes/auth.ts"
      provides: "Clean auth routes"
  key_links: []
---

<objective>
Remove legacy mock OTP code and consolidate the login flow to use only Firebase.

Purpose: Remove technical debt and confusing "double login" UX.
Output: Cleaned up codebase and streamlined login flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/src/routes/auth.ts
@web/src/lib/api.ts
@web/src/pages/BuyerLoginPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Consolidate Login UX</name>
  <files>web/src/pages/BuyerLoginPage.tsx, web/src/pages/VerifyOtpPage.tsx, web/src/App.tsx</files>
  <action>
    1. Modify `web/src/pages/BuyerLoginPage.tsx` to render the `PhoneLoginForm` component directly. Remove the local form state and `authApi.requestOtp` call.
    2. Delete `web/src/pages/VerifyOtpPage.tsx`.
    3. Update `web/src/App.tsx` to remove the `/verify-otp` route.
  </action>
  <verify>
    - `grep "PhoneLoginForm" web/src/pages/BuyerLoginPage.tsx`
    - `ls web/src/pages/VerifyOtpPage.tsx` (should fail)
  </verify>
  <done>Login UI consolidated</done>
</task>

<task type="auto">
  <name>Clean up Client API</name>
  <files>web/src/lib/api.ts</files>
  <action>
    Remove `requestOtp` and `verifyOtp` methods from the `authApi` object in `web/src/lib/api.ts`. Keep `firebaseVerify`.
  </action>
  <verify>grep -v "requestOtp" web/src/lib/api.ts</verify>
  <done>Legacy client methods removed</done>
</task>

<task type="auto">
  <name>Clean up Server API</name>
  <files>server/src/routes/auth.ts, server/src/schemas/auth.ts, server/src/utils/password.ts</files>
  <action>
    1. In `server/src/routes/auth.ts`: Remove `POST /auth/request-otp` and `POST /auth/verify-otp` route registrations.
    2. In `server/src/schemas/auth.ts`: Remove `requestOTPSchema` and `verifyOTPSchema` exports.
    3. In `server/src/utils/password.ts`: Remove `generateOTP` and `getOTPExpiry` if they are no longer used.
  </action>
  <verify>grep -v "request-otp" server/src/routes/auth.ts</verify>
  <done>Legacy server routes removed</done>
</task>

<task type="auto">
  <name>Verify Cooldown Logic</name>
  <files>web/src/hooks/usePhoneAuth.ts, web/src/components/auth/PhoneLoginForm.tsx</files>
  <action>
    Review `usePhoneAuth.ts` to ensure `cooldown` state is managed correctly (starts at 60, decrements).
    Review `PhoneLoginForm.tsx` to ensure the "Send OTP" or "Resend OTP" button is disabled when `cooldown > 0`.
    Add comments if logic is obscure.
  </action>
  <verify>grep "cooldown" web/src/hooks/usePhoneAuth.ts</verify>
  <done>Cooldown verified</done>
</task>

</tasks>

<verification>
- [ ] Build web: `npm run build` in web
- [ ] Build server: `npm run build` in server
</verification>

<success_criteria>
- Single login screen
- No legacy OTP code
- Builds pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-auth-cleanup/22-01-SUMMARY.md`
</output>

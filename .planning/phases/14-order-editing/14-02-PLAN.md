---
phase: 14-order-editing
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified: [web/src/lib/api.ts, web/src/components/buyer/OrderCard.tsx, web/src/pages/buyer/EditOrderPage.tsx, web/src/App.tsx]
autonomous: false
---

<objective>
Implement buyer-facing UI for editing placed orders before cutoff.

Purpose: Allow buyers to modify their orders through a user-friendly interface that reuses existing shop/cart components.
Output: Edit button on OrderCard, EditOrderPage with item management, integrated with backend API.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-order-editing/14-01-SUMMARY.md

@web/src/lib/api.ts
@web/src/components/buyer/OrderCard.tsx
@web/src/pages/BuyerDashboardPage.tsx
@web/src/pages/buyer/ShopPage.tsx
@web/src/stores/cart.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add order editing API method</name>
  <files>web/src/lib/api.ts</files>
  <action>
Add `editOrder` method to `ordersApi` object:

```typescript
editOrder: async (orderId: string, data: {
  fulfillmentType?: 'PICKUP' | 'DELIVERY';
  items?: Array<{ batchProductId: string; orderedQty: number }>;
}) => {
  return fetchApi<{ order: Order }>(`/orders/${orderId}`, {
    method: 'PATCH',
    body: JSON.stringify(data),
  });
},
```

This follows the existing pattern used by other API methods in the file.
  </action>
  <verify>TypeScript compilation: `cd web && npx tsc --noEmit`</verify>
  <done>editOrder method added and typed correctly</done>
</task>

<task type="auto">
  <name>Task 2: Add Edit button to OrderCard</name>
  <files>web/src/components/buyer/OrderCard.tsx</files>
  <action>
Add "Edit Order" button that shows conditionally:

**Show edit button when ALL conditions are true:**
1. `order.status === 'PLACED'`
2. `order.batch?.status === 'OPEN'`
3. `new Date(order.batch?.cutoffAt) > new Date()`

**Button placement:**
- Add in the CardHeader section, next to the total amount
- Use Button component with variant="outline" and size="sm"
- Icon: Pencil from lucide-react
- Text: "Edit"
- Color: mandi-green border and text

**On click:**
- Navigate to `/orders/${order.id}/edit` using `useNavigate`

**Also add:**
- Small helper text below the button showing time remaining until cutoff
- Format: "Edit until {cutoff time}" or "X hours left to edit"
  </action>
  <verify>TypeScript compilation: `cd web && npx tsc --noEmit`</verify>
  <done>Edit button appears on editable orders, hidden on non-editable orders</done>
</task>

<task type="auto">
  <name>Task 3: Create EditOrderPage</name>
  <files>web/src/pages/buyer/EditOrderPage.tsx</files>
  <action>
Create new page component for editing orders:

**Page structure:**
1. Fetch order by ID from URL params (`useParams`)
2. Fetch batch products for the order's batch (`GET /batches/:batchId/products`)
3. Display loading state while fetching
4. Display error if order not editable (not PLACED, batch not OPEN, past cutoff)

**UI Layout (reuse shop patterns):**
1. Header with "Edit Order" title and back button
2. Current order info (batch name, delivery date)
3. Products list grouped by farmer (similar to ShopPage)
4. Each product shows:
   - Current ordered qty (editable input)
   - +/- buttons for quantity adjustment
   - Remove button (sets qty to 0)
   - "Add" button for products not in order
5. Fulfillment type selector (PICKUP/DELIVERY radio buttons)
6. Order summary showing new total
7. "Save Changes" button (primary, disabled if no changes)
8. "Cancel Order" button (destructive, with confirmation dialog)

**State management:**
- Local state for edited items (don't use cart store - this is separate from cart)
- Track original vs current state to detect changes
- Calculate new totals client-side for preview

**Save flow:**
1. Call `ordersApi.editOrder(orderId, { fulfillmentType, items })`
2. On success: Show toast, navigate back to dashboard
3. On error: Show error toast with message

**Cancel order flow:**
1. Show confirmation dialog: "Are you sure you want to cancel this order?"
2. On confirm: Call `ordersApi.editOrder(orderId, { items: [] })`
3. On success: Show toast "Order cancelled", navigate to dashboard
  </action>
  <verify>TypeScript compilation: `cd web && npx tsc --noEmit`</verify>
  <done>EditOrderPage component created with full editing functionality</done>
</task>

<task type="auto">
  <name>Task 4: Add route for EditOrderPage</name>
  <files>web/src/App.tsx</files>
  <action>
Add route for the edit order page:

1. Import EditOrderPage: `import { EditOrderPage } from '@/pages/buyer/EditOrderPage';`
2. Add route inside the authenticated buyer routes section:
   ```tsx
   <Route path="/orders/:orderId/edit" element={<EditOrderPage />} />
   ```

Place it near other buyer routes (after /shop, /checkout, etc.).
  </action>
  <verify>TypeScript compilation: `cd web && npx tsc --noEmit`</verify>
  <done>Route registered and accessible</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Order editing UI with Edit button on OrderCard and full EditOrderPage</what-built>
  <how-to-verify>
    1. Run: `npm run dev` (starts both server and web)
    2. Login as a buyer who has a PLACED order in an OPEN batch
    3. On Buyer Dashboard, verify:
       - "Edit" button appears on the order card
       - Button shows time remaining until cutoff
    4. Click "Edit" button:
       - EditOrderPage loads with current order items
       - Can increase/decrease quantities
       - Can add new products from the batch
       - Can remove items
       - Fulfillment type is selectable
       - Total updates as changes are made
    5. Make changes and click "Save Changes":
       - Success toast appears
       - Redirected to dashboard
       - Order reflects new items/quantities
    6. Test cancel flow:
       - Click "Cancel Order" button
       - Confirmation dialog appears
       - Confirm cancellation
       - Order status changes to CANCELLED
    7. Verify edit button NOT shown when:
       - Order status is COMMITMENT_PAID
       - Batch is CLOSED
       - Cutoff has passed
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npx tsc --noEmit` succeeds
- [ ] `npm run build --workspace=web` succeeds
- [ ] Edit button appears correctly on editable orders
- [ ] EditOrderPage works for all edit scenarios
- [ ] Cancel order flow works with confirmation
- [ ] Human verification passed
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Buyers can edit PLACED orders before cutoff
- Clear visual indication of edit window
- Smooth UX with proper loading/error states
- Cancel flow includes confirmation
</success_criteria>

<output>
After completion, create `.planning/phases/14-order-editing/14-02-SUMMARY.md`
</output>

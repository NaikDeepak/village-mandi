---
phase: 20-security-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [server/src/plugins/rate-limit.ts]
autonomous: true
must_haves:
  truths:
    - "SMS endpoints have strict per-IP rate limits"
    - "Rate limit headers are present in responses"
  artifacts:
    - path: "server/src/plugins/rate-limit.ts"
      provides: "Tuned rate limit configuration"
  key_links: []
---

<objective>
Tune rate limiting and add security headers.

Purpose: Prevent SMS pumping and brute force attacks with specific, strict limits on auth endpoints.
Output: Tuned rate limiter configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-backend-auth/18-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Refine Auth Rate Limits</name>
  <files>server/src/plugins/rate-limit.ts</files>
  <action>
    Update the rate limit plugin configuration (created in Phase 18) to be more granular.
    - `/auth/firebase-verify`: 5 requests per 15 minutes per IP (Strict - login attempts).
    - `/auth/refresh`: 10 requests per hour (Session refresh).
    - Global default: 100 requests per minute (Standard API).
    - Ensure `keyGenerator` uses client IP correctly (trust proxy if behind Vercel/Load Balancer).
  </action>
  <verify>Configuration reflects strict auth limits</verify>
  <done>Rate limits tuned for production safety</done>
</task>

<task type="auto">
  <name>Configure Trust Proxy</name>
  <files>server/src/index.ts</files>
  <action>
    Since we are deploying to Vercel, Fastify must trust the proxy to get the real client IP for rate limiting.
    Set `trustProxy: true` in Fastify instantiation.
  </action>
  <verify>Fastify created with trustProxy: true</verify>
  <done>IP detection works correctly on Vercel</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Rate limits logic reviewed
- [ ] Trust proxy enabled
</verification>

<success_criteria>
- Strict rate limits on auth routes
- Correct IP detection behind proxy
</success_criteria>

<output>
After completion, create `.planning/phases/20-security-hardening/20-02-SUMMARY.md`
</output>

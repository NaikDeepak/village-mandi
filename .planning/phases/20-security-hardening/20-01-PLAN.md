---
phase: 20-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [server/src/middleware/auth.ts, server/src/plugins/firebase.ts, server/src/routes/auth.ts]
autonomous: true
must_haves:
  truths:
    - "Requests without valid App Check token are rejected (optional enforcement mode)"
    - "Security events are logged with structured metadata"
  artifacts:
    - path: "server/src/middleware/app-check.ts"
      provides: "App Check verification middleware"
  key_links:
    - from: "/auth/firebase-verify"
      to: "admin.appCheck().verifyToken"
      via: "Middleware"
---

<objective>
Implement Firebase App Check verification and security auditing.

Purpose: Ensure only authorized client applications can access backend APIs, preventing abuse from scripts/bots.
Output: App Check middleware and audit logging.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-security-hardening/20-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Create App Check Middleware</name>
  <files>server/src/middleware/app-check.ts</files>
  <action>
    Create a Fastify middleware/preHandler that verifies the `X-Firebase-AppCheck` header.
    - Use `admin.appCheck().verifyToken(token)`.
    - Handle success: Log success, proceed.
    - Handle failure: Log warning/error.
    - Important: For V1, implement in "monitoring mode" (log but don't block) or allow fallback to avoid breaking dev/review flows, unless strictly enforced. Let's make it configurable via env var `APP_CHECK_ENFORCED=false`.
  </action>
  <verify>Middleware compiles and handles token verification logic</verify>
  <done>App Check verification logic exists</done>
</task>

<task type="auto">
  <name>Register App Check on Critical Routes</name>
  <files>server/src/routes/auth.ts, server/src/index.ts</files>
  <action>
    Apply the App Check middleware to sensitive routes:
    - `POST /auth/firebase-verify` (Critical: prevents unauthorized token exchange)
    - `POST /auth/request-otp` (if implemented/exposed)
  </action>
  <verify>Routes utilize the preHandler</verify>
  <done>Critical routes protected</done>
</task>

<task type="auto">
  <name>Enhance Security Audit Logging</name>
  <files>server/src/plugins/logger.ts, server/src/middleware/app-check.ts</files>
  <action>
    Ensure security events (auth failures, rate limit hits, app check failures) are logged with:
    - IP address
    - User Agent
    - Request Path
    - Failure Reason
    Use existing Pino logger structure.
  </action>
  <verify>Logs contain security metadata</verify>
  <done>Security auditing active</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Middleware handles valid/invalid tokens
- [ ] Audit logs capture security events
</verification>

<success_criteria>
- App Check verification implemented
- Configurable enforcement (monitoring vs blocking)
- Security audit logs active
</success_criteria>

<output>
After completion, create `.planning/phases/20-security-hardening/20-01-SUMMARY.md`
</output>

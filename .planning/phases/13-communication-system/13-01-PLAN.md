# Plan 13-01: WhatsApp Integration & Event Notifications

## Objective
Implement a structured communication system using WhatsApp click-to-chat to streamline notifications for buyers and farmers throughout the batch lifecycle.

## Tasks

### 1. Communication Utility (Frontend)
- [ ] Create `web/src/lib/communication.ts`:
  - [ ] Helper function `getWhatsAppLink(phone, message)`.
  - [ ] Template generators for:
    - [ ] New Batch Open (Broad)
    - [ ] Payment Request (Commitment & Final)
    - [ ] Order Status Update (Packed / Ready for Pickup)
    - [ ] Farmer Payout Confirmation

### 2. Backend Logging API
- [ ] Create `POST /logs/communication` in `server/src/routes/logs.ts`:
  - [ ] Record communication events in `EventLog` table.
  - [ ] Include metadata: `recipientId`, `messageType`, `channel` (WhatsApp).

### 3. Admin UI Enhancements
- [ ] **Batches Page**: Add "Notify Buyers" button for OPEN batches.
- [ ] **Order Detail Page**:
  - [ ] Add "WhatsApp Buyer" button with status-aware templates.
  - [ ] Show communication history for this order (from `EventLog`).
- [ ] **Batch Packing Page**: Add "Notify Buyer" button next to each packed order.
- [ ] **Farmer Payouts Page**: Add "Send Confirmation" button after logging a payout.

### 4. Buyer Experience
- [ ] **Buyer Dashboard**: Add "Contact Hub Manager" WhatsApp button.
- [ ] **Order Card**: Add "Help & Support" link pointing to WhatsApp.

## Verification
- [ ] Verify WhatsApp links open correctly with pre-filled text.
- [ ] Verify `EventLog` entries are created after clicking communication buttons.
- [ ] Ensure phone numbers are correctly formatted (adding 91 prefix if missing).

## Success Criteria
- [ ] Admin can notify all buyers of a new batch in < 3 clicks.
- [ ] Admin can request payments from buyers with one click.
- [ ] All significant communications are logged for audit.

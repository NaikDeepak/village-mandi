# Plan 11-01: Farmer Payouts API & UI

## Objective
Implement the backend logic for calculating farmer payouts and the frontend UI for admins to log and track these payments.

## Tasks

### 1. Backend Implementation
- [ ] Create `server/src/routes/payouts.ts`.
- [ ] Implement `GET /batches/:id/payouts` endpoint:
  - Aggregate all orders in the batch.
  - Group by farmer.
  - Calculate `totalOwed` based on `OrderItem.finalQty` (falling back to `orderedQty` if `finalQty` is null).
  - Include existing `FarmerPayout` records for each farmer in this batch.
- [ ] Implement `POST /batches/:id/payouts` endpoint:
  - Validate `farmerId`, `amount`, `upiReference`, `paidAt`.
  - Create `FarmerPayout` record.
  - Log event in `EventLog`.
- [ ] Register routes in `server/index.ts`.
- [ ] Add integration tests in `server/src/routes/payouts.test.ts`.

### 2. Frontend Implementation
- [ ] Update `web/src/lib/api.ts`:
  - Add `payoutsApi.getByBatch(batchId)`.
  - Add `payoutsApi.logPayout(batchId, data)`.
- [ ] Create `web/src/pages/admin/BatchPayoutsPage.tsx`:
  - Summary of total payouts for the batch.
  - Table showing each farmer's name, total owed, total paid, and balance.
  - "Log Payout" button for each farmer that opens a modal.
  - List of recent payouts for the batch.
- [ ] Add "Farmer Payouts" link to `BatchDetailPage.tsx`.

### 3. Verification
- [ ] `npm run test --workspace=server server/src/routes/payouts.test.ts`
- [ ] `npm run build` in web workspace.
- [ ] Manual verification of the payout flow.

## Success Criteria
- [ ] Admin can see a precise amount owed to each farmer for a batch.
- [ ] Admin can log a payout with a UPI/Cash reference.
- [ ] Balance updates correctly after a payout is logged.
- [ ] All payouts are recorded in the `EventLog`.

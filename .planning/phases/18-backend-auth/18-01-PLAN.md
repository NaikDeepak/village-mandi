---
phase: 18-backend-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [server/package.json, server/prisma/schema.prisma, server/src/plugins/firebase.ts, server/src/middleware/auth.ts, server/src/routes/auth.ts]
autonomous: true
must_haves:
  truths:
    - "API accepts valid Firebase ID tokens"
    - "New users are auto-created in Postgres"
    - "Existing users are linked by phone number"
  artifacts:
    - path: "server/src/plugins/firebase.ts"
      provides: "Firebase Admin initialization"
    - path: "server/src/routes/auth.ts"
      provides: "POST /auth/firebase-verify endpoint"
  key_links:
    - from: "/auth/firebase-verify"
      to: "firebase.auth().verifyIdToken"
      via: "Firebase Admin SDK"
    - from: "/auth/firebase-verify"
      to: "prisma.user"
      via: "upsert operation"
---

<objective>
Implement core backend infrastructure for Firebase Authentication.

Purpose: Enable secure token exchange and user synchronization between Firebase and Postgres.
Output: Validated auth endpoints and database schema updates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md
@server/package.json
</context>

<tasks>

<task type="auto">
  <name>Install Dependencies</name>
  <files>server/package.json</files>
  <action>
    Install `firebase-admin` in the server workspace.
    Run `npm install firebase-admin --workspace=server`.
  </action>
  <verify>grep "firebase-admin" server/package.json</verify>
  <done>Dependencies installed</done>
</task>

<task type="auto">
  <name>Update Database Schema</name>
  <files>server/prisma/schema.prisma</files>
  <action>
    Add `firebaseUid` field to the User model.
    - Type: String? (nullable initially, but should be unique)
    - Constraint: @unique
    - Index: @@index([firebaseUid])

    Run `npx prisma generate` and create migration `npx prisma migrate dev --name add_firebase_uid`.
  </action>
  <verify>npx prisma validate</verify>
  <done>Schema updated and migration created</done>
</task>

<task type="auto">
  <name>Create Firebase Plugin</name>
  <files>server/src/plugins/firebase.ts</files>
  <action>
    Create a Fastify plugin that initializes `firebase-admin`.
    - Use `FIREBASE_SERVICE_ACCOUNT_JSON` from env (parse it).
    - Initialize app only if `admin.apps.length === 0`.
    - Decorate fastify with `firebase` instance or auth helper.
  </action>
  <verify>Plugin file exists and compiles</verify>
  <done>Firebase Admin initialized</done>
</task>

<task type="auto">
  <name>Implement Verification Endpoint</name>
  <files>server/src/routes/auth.ts</files>
  <action>
    Create `POST /auth/firebase-verify` endpoint.
    Logic:
    1. Receive `{ idToken }` in body.
    2. Verify token using `admin.auth().verifyIdToken(idToken)`.
    3. Extract `uid` and `phone_number`.
    4. Upsert User in Prisma:
       - Find by `phone` OR `firebaseUid`.
       - If found: Update `firebaseUid` if missing.
       - If not found: Create new user with role 'BUYER'.
    5. Generate internal JWT using existing `fastify.jwt.sign`.
    6. Return `{ token, user }`.
  </action>
  <verify>curl test (mocked) or unit test</verify>
  <done>Endpoint handles token exchange and user sync</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` in server succeeds
- [ ] Prisma migration applied
</verification>

<success_criteria>
- Firebase Admin SDK integrated
- Database schema supports Firebase UID
- Token exchange endpoint functional
</success_criteria>

<output>
After completion, create `.planning/phases/18-backend-auth/18-01-SUMMARY.md`
</output>

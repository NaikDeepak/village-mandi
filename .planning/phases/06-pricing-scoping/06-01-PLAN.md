---
phase: 06-pricing-scoping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [server/src/schemas/batch-products.ts, server/src/routes/batch-products.ts, server/src/routes/batch-products.test.ts, server/index.ts]
autonomous: true
---

<objective>
Implement BatchProduct API for scoping products into batches with pricing.

Purpose: Enable admins to add products to a batch with specific pricing, facilitation fees, and MOQ. This is the foundation for the ordering flow.
Output: CRUD API for batch products with validation and tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@server/prisma/schema.prisma
@server/src/routes/batches.ts
@server/src/routes/products.ts
@server/src/schemas/batches.ts
@server/src/schemas/products.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BatchProduct Zod schemas</name>
  <files>server/src/schemas/batch-products.ts</files>
  <action>
Create Zod schemas for batch product validation:

1. `addBatchProductSchema`:
   - productId: string().uuid() - required
   - pricePerUnit: number().positive() - required (price in rupees)
   - facilitationPercent: number().min(0).max(100) - required (mandi's cut)
   - minOrderQty: number().positive() - required (MOQ)
   - maxOrderQty: number().positive().optional() - max quantity limit

2. `updateBatchProductSchema`:
   - pricePerUnit: number().positive().optional()
   - facilitationPercent: number().min(0).max(100).optional()
   - minOrderQty: number().positive().optional()
   - maxOrderQty: number().positive().nullable().optional()
   - isActive: boolean().optional()

Add refinement: if maxOrderQty is provided, it must be >= minOrderQty.

Export types: AddBatchProductInput, UpdateBatchProductInput
  </action>
  <verify>tsc --noEmit in server directory passes</verify>
  <done>Schema file exists with proper validation rules and exported types</done>
</task>

<task type="auto">
  <name>Task 2: Create batch-products routes</name>
  <files>server/src/routes/batch-products.ts, server/index.ts</files>
  <action>
Create batch-products routes following the pattern in batches.ts and products.ts:

**GET /batches/:id/products** (admin only)
- Fetch all batch products for a batch
- Include product details and farmer info
- Filter by isActive (default true)

**POST /batches/:id/products** (admin only)
- Add a product to a batch with pricing
- Validate batch exists and is DRAFT (only DRAFT batches can be modified)
- Validate product exists and is active
- Check product not already in batch (unique constraint)
- Create BatchProduct record
- Return created batch product with product and farmer details

**GET /batch-products/:id** (admin only)
- Fetch single batch product by ID
- Include product, farmer, and batch details

**PUT /batch-products/:id** (admin only)
- Update batch product pricing
- Validate parent batch is DRAFT
- Return updated batch product

**DELETE /batch-products/:id** (admin only)
- Soft delete (set isActive = false)
- Hard delete with force=true query param
- Validate parent batch is DRAFT

**Key validations:**
- DRAFT-only modification: All create/update/delete operations require batch.status === 'DRAFT'
- Return 400 with clear error message if batch is not DRAFT

Register routes in server/index.ts under `/api` prefix.
  </action>
  <verify>Server starts without errors, routes are registered</verify>
  <done>All 5 endpoints work: GET batch products, POST add product, GET single, PUT update, DELETE remove</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for batch-products API</name>
  <files>server/src/routes/batch-products.test.ts</files>
  <action>
Create comprehensive tests following the pattern in batches.test.ts:

**Setup:**
- Create test hub, batch (DRAFT), farmer, and product in beforeEach
- Clean up in afterEach

**Test cases:**

GET /batches/:id/products:
- Returns empty array for batch with no products
- Returns products with farmer details
- Filters by isActive

POST /batches/:id/products:
- Adds product with pricing successfully
- Rejects if batch is not DRAFT (OPEN, CLOSED, etc.)
- Rejects if product already in batch
- Rejects if product not found
- Rejects if product is inactive
- Validates pricing fields (positive numbers, percent range)

GET /batch-products/:id:
- Returns batch product with full details
- Returns 404 for non-existent ID

PUT /batch-products/:id:
- Updates pricing successfully
- Rejects if batch is not DRAFT
- Validates maxOrderQty >= minOrderQty

DELETE /batch-products/:id:
- Soft deletes by default
- Hard deletes with force=true
- Rejects if batch is not DRAFT

Target: 15-20 tests covering all endpoints and edge cases.
  </action>
  <verify>npm test in server directory - all batch-products tests pass</verify>
  <done>All tests pass, coverage includes happy paths and validation errors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` in server directory succeeds
- [ ] `npm test` in server directory passes all tests (including new batch-products tests)
- [ ] No TypeScript errors
- [ ] Routes registered and accessible (verify with curl or Postman)
</verification>

<success_criteria>

- All tasks completed
- BatchProduct CRUD API works end-to-end
- DRAFT-only modification enforced
- 15+ tests passing
- No regressions in existing tests
  </success_criteria>

<output>
After completion, create `.planning/phases/06-pricing-scoping/06-01-SUMMARY.md`
</output>

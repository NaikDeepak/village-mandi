---
phase: 06-pricing-scoping
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: [web/src/pages/admin/BatchDetailPage.tsx, web/src/components/admin/AddProductToBatchModal.tsx, web/src/lib/api.ts, web/src/types.ts]
autonomous: false
---

<objective>
Implement Admin UI for scoping products into batches with pricing.

Purpose: Enable admins to add, edit, and remove products from a batch with pricing details through a user-friendly interface.
Output: BatchDetailPage with products section, add/edit modal, and full CRUD functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-pricing-scoping/06-01-SUMMARY.md

@web/src/pages/admin/BatchDetailPage.tsx
@web/src/pages/admin/ProductFormPage.tsx
@web/src/lib/api.ts
@web/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add API client and types for batch products</name>
  <files>web/src/lib/api.ts, web/src/types.ts</files>
  <action>
Update types.ts:
- Add BatchProduct type with: id, batchId, productId, pricePerUnit, facilitationPercent, minOrderQty, maxOrderQty, isActive, product (nested), createdAt
- Add Product nested type if not complete (id, name, unit, farmer nested)
- Add AddBatchProductInput type matching the API schema

Update api.ts:
- Add batchProductsApi object with methods:
  - getByBatch(batchId: string) - GET /batches/:id/products
  - add(batchId: string, data: AddBatchProductInput) - POST /batches/:id/products
  - update(id: string, data: Partial) - PUT /batch-products/:id
  - remove(id: string, force?: boolean) - DELETE /batch-products/:id

Follow existing patterns in api.ts for error handling and response typing.
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>API client and types ready for batch products</done>
</task>

<task type="auto">
  <name>Task 2: Add Products section to BatchDetailPage</name>
  <files>web/src/pages/admin/BatchDetailPage.tsx</files>
  <action>
Add a "Products" section below the batch details:

**For DRAFT batches:**
- Section header: "Products in this Batch" with "Add Product" button
- Table/list of batch products showing:
  - Product name (linked to product)
  - Farmer name
  - Price per unit (formatted as ₹X.XX/unit)
  - Facilitation %
  - MOQ (Min Qty)
  - Max Qty (or "No limit")
  - Actions: Edit, Remove
- Empty state: "No products added yet. Add products to this batch to set pricing."
- Edit button opens modal with current values
- Remove button shows confirmation, calls delete API

**For non-DRAFT batches:**
- Same table but read-only (no Add/Edit/Remove buttons)
- Info message: "Product pricing is locked after batch is opened."

Fetch products on component mount using batchProductsApi.getByBatch().
Handle loading and error states.
  </action>
  <verify>Page renders without errors, products section visible</verify>
  <done>Products section shows in BatchDetailPage with CRUD actions for DRAFT batches</done>
</task>

<task type="auto">
  <name>Task 3: Create AddProductToBatchModal component</name>
  <files>web/src/components/admin/AddProductToBatchModal.tsx</files>
  <action>
Create modal component for adding/editing batch products:

**Props:**
- batchId: string
- isOpen: boolean
- onClose: () => void
- onSuccess: () => void (to refresh list)
- existingProduct?: BatchProduct (for edit mode)

**Product selection (add mode):**
- Dropdown/select showing available products grouped by farmer
- Filter out products already in the batch
- Show product name, unit, and farmer name

**Pricing form fields:**
- Price per Unit (₹): number input, required
- Facilitation Fee (%): number input, required, 0-100
- Minimum Order Qty: number input, required
- Maximum Order Qty: number input, optional (leave empty for no limit)

**Validation:**
- All required fields filled
- Max qty >= Min qty if max is set
- Positive numbers

**Behavior:**
- Add mode: Select product + fill pricing, submit creates batch product
- Edit mode: Product shown as read-only, only pricing editable
- Loading state during submission
- Error display for API errors
- Close modal and call onSuccess on successful save

Use React Hook Form + Zod for form handling (consistent with other forms).
Style with Tailwind, use existing Button component.
  </action>
  <verify>Component renders, form validation works</verify>
  <done>Modal works for both add and edit modes with proper validation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Product scoping UI in BatchDetailPage with add/edit modal</what-built>
  <how-to-verify>
    1. Run: npm run dev (in both web and server directories)
    2. Visit: http://localhost:5173/admin/batches
    3. Create a new DRAFT batch if none exists
    4. Click "View" on the DRAFT batch to go to detail page
    5. Verify "Products in this Batch" section appears
    6. Click "Add Product" button
    7. Verify modal opens with product dropdown and pricing fields
    8. Select a product, fill pricing (e.g., ₹50, 5%, MOQ 1)
    9. Submit and verify product appears in the list
    10. Click "Edit" on the product, change price, save
    11. Click "Remove" on the product, confirm deletion
    12. Transition batch to OPEN, verify Add/Edit/Remove buttons disappear
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` in web directory succeeds
- [ ] No TypeScript errors
- [ ] Products section visible in BatchDetailPage
- [ ] Add/Edit/Remove functionality works for DRAFT batches
- [ ] Read-only mode for non-DRAFT batches
- [ ] Human verification passed
</verification>

<success_criteria>

- All tasks completed
- Product scoping UI works end-to-end
- DRAFT-only modification enforced in UI
- Human approved visual/functional verification
  </success_criteria>

<output>
After completion, create `.planning/phases/06-pricing-scoping/06-02-SUMMARY.md`
</output>
